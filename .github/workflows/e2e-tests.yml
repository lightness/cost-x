name: E2E Tests
on:
  push:
    branches: [main, develop, feature/tests]
  pull_request:
    branches: [main]

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    # Define environment variables
    env:
      PORT: 9998
      DATABASE_URL: "postgresql://postgres:12345@127.0.0.1:9992/cost_x_db?schema=public"
      REDIS_URL: "redis://127.0.0.1:6380/0"
      MAILERSEND_API_KEY: "fake"
      SENDER_EMAIL: "no-reply@test.net"
      CONFIRM_EMAIL_LINK_URL: "http://localhost:9998/confirm-email"
      RESET_PASSWORD_LINK_URL: "http://example.com"
      ACCESS_JWT_EXPIRES_IN: "365d"
      REFRESH_JWT_EXPIRES_IN: "366d"

    services:
      # PostgreSQL service
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: 12345
          POSTGRES_DB: cost_x_db
        ports:
          - 9992:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      # Redis service (if needed)
      redis:
        image: redis:7-alpine
        ports:
          - 6380:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Load env vars
        run: |
          cat .env.test >> "$GITHUB_ENV"

      - name: Verify env var
        run: |
          echo "$DATABASE_URL"

      - name: Run database migrations
        run: npm run prisma:migration:up
        # env:
        #   DATABASE_URL: ${{ env.DATABASE_URL }}

      - name: Generate Prisma client
        run: npm run prisma:client:generate
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}

      - name: Run E2E tests
        run: npm run test
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          REDIS_URL: ${{ env.REDIS_URL }}
          PORT: ${{ env.PORT }}
          MAILERSEND_API_KEY: ${{ env.MAILERSEND_API_KEY }}
          SENDER_EMAIL: ${{ env.SENDER_EMAIL }}
          CONFIRM_EMAIL_LINK_URL: ${{ env.CONFIRM_EMAIL_LINK_URL }}
          RESET_PASSWORD_LINK_URL: ${{ env.RESET_PASSWORD_LINK_URL }}
          ACCESS_JWT_EXPIRES_IN: ${{ env.ACCESS_JWT_EXPIRES_IN }}
          REFRESH_JWT_EXPIRES_IN: ${{ env.REFRESH_JWT_EXPIRES_IN }}
